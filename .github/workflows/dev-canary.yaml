on:
  push:
    branches:
      - dev-canary

name: Deploy Dev Canary

jobs:
  deploy:
    name: Deploy
    runs-on:
      - self-hosted
      - dev
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: us-east-1
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - name: "Build, tag, and push image to Amazon ECR"
        id: build-image
        env:
          ECR_REGISTRY: "${{ steps.login-ecr.outputs.registry }}"
          ECR_REPOSITORY: meetingsdk-react-sample
          IMAGE_TAG: "${{ github.sha }}"
          ENVIRONMENT: dev
          NODE_ENV: dev
        run: >
          make

          echo "::set-output
          name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
      - name: Deploy
        id: deploy-k8s
        env:
          IMAGE_URL: "${{ steps.build-image.outputs.image }}"
          ECR_REGISTRY: "${{ steps.login-ecr.outputs.registry }}"
          ECR_REPOSITORY: meetingsdk-react-sample
          IMAGE_TAG: "${{ github.sha }}"
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 -d > ~/.kube/config
          cd ./deployments/meetingsdk-react-sample && make upgrade-canary && cd -
